<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "https://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.green.greengram.application.feed.FeedMapper">


    <select id="findAllLimitedId">
<!--        SELECT f.feed_id, f.contents, f.location, f.created_at,-->
<!--        f.writer_user_id, u.uid AS writerUid, u.nick_name AS writerNickName, u.pic AS writerPic-->
<!--        FROM feed as f-->
<!--        JOIN user as u ON u.user_id = f.writer_user_id-->
<!--        ORDER BY f.feed_id DESC-->
<!--        LIMIT #{startIdx}, #{size}-->

<!--        SELECT f.feed_id, f.contents, f.location, f.created_at,-->
<!--                 f.writer_user_id, u.uid AS writerUid-->
<!--                ,u.nick_name AS writerNickName, u.pic AS writerPic-->
<!--                , l.feed_id IS NOT NULL AS isLike-->
<!--        &lt;!&ndash;        ,IF(u.user_id = l.user_id, '1','0') AS isLike 함수 호출이라 속도 느려짐 &ndash;&gt;-->
<!--                , l.like_count as likeCount-->
<!--            FROM feed AS f-->
<!--                INNER JOIN user AS u-->
<!--                    ON u.user_id = f.writer_user_id-->

<!--                LEFT JOIN feed_like as l-->
<!--                    ON f.feed_id  = l.feed_id-->
<!--                        and l.user_id = #{signedUserId}-->
<!--        ORDER BY f.feed_id DESC-->
<!--        LIMIT #{startIdx}, #{size}-->

        SELECT f.feed_id, f.contents, f.location, f.created_at,
        f.writer_user_id, u.uid AS writerUid
        ,u.nick_name AS writerNickName, u.pic AS writerPic
        , l.feed_id IS NOT NULL AS isLike
<!--        , ( select  COUNT(user_id) FROM feed_like WHERE f.feed_id = feed_id) AS likeCount-->
        , COUNT(lc.user_id) AS likeCount
        FROM feed AS f
        INNER JOIN user AS u
        ON u.user_id = f.writer_user_id

        LEFT JOIN feed_like as l
        ON f.feed_id  = l.feed_id
        and l.user_id = #{signedUserId}
        <if test="profileUserId != null">
            WHERE f.writer_user_id = #{profileUserId}
        </if>

        LEFT JOIN feed_like AS lc
        ON f.feed_id = lc.feed_id

        GROUP BY f.feed_id

        ORDER BY f.feed_id DESC
        LIMIT #{startIdx}, #{size};




    </select>



    <select id="findAllPicByFeedId">
        SELECT pic FROM feed_pic
        WHERE feed_id = #{feed_id}
    </select>




</mapper>